USE PeluqueriaCanina

GO

CREATE PROCEDURE SP_LoginUsuario(
	@nombre VARCHAR(100),
	@contrase�a  VARCHAR(20)
)
AS
BEGIN
	DECLARE @activo BIT
	---Se verifica si el nombre y la contrase�a son las mismas---
	IF @nombre = nombre_usuario AND @contrase�a = contrase�a BEGIN
		---Se le da el valor de "activo" de la tabla a la variable "@activo"---
		SELECT @activo = activo FROM Usuario WHERE nombre_usuario = @nombre AND contrase�a = @contrase�a
	END
	ELSE
		RAISERROR('El usuario y/o la contrase�a ingresada es incorrecta',16,1)
	END
	---Se verifica si el registro esta activo---
	IF @activo = 1 BEGIN
		SELECT 
			---Muestra que el registro fue valido---
			id_usuario,tipo_usuario, 'Login exitoso' AS mensaje
			FROM Usuario 
			WHERE nombre_usuario = @nombre AND contrase�a = @contrase�a
	END
	ELSE
	BEGIN
		RAISERROR('Este usuario esta inactivo',16,1)
	END
END

GO


CREATE TRIGGER SP_RegistrarActividad ON ActividadUsuario
INSTEAD OF  INSERT
AS
BEGIN
	BEGIN TRY
		BEGIN TRANSACTION
		DECLARE @id INT
		---Se registra la actividad---
		SELECT @id = id_usuario FROM inserted

		INSERT INTO ActividadUsuario(id_usuario,fecha,descripcion)
		SELECT id_usuario, GETDATE(), descripcion
		FROM Inserted
		COMMIT TRANSACTION
	END TRY
	BEGIN CATCH
		---Si hubo un error, se vuelve atras y no se registra la actividad---
		ROLLBACK TRANSACTION
	END CATCH
END

GO

CREATE VIEW VW_ClientesActivos AS
SELECT T1.apellido+','+ T1.nombre AS Persona,  T2.persona_autorizada_retiro, T2.franja_horaria_preferida, T2.observaciones,T3.nombre+','+ T3.raza AS Mascota, T4.fecha, T4.hora
FROM Personas AS T1
INNER JOIN Cliente AS T2 ON T1.id_persona = T2.id_persona
INNER JOIN Mascota AS T3 ON T2.id_cliente = T3.id_cliente
INNER JOIN Turno AS T4 ON T3.id_mascota = T4.id_mascota
WHERE T1.activo = 1 AND T2.activo = 1 AND T3.activo = 1 AND (T4.estado = 'programado' OR T4.estado = 'confirmado')
